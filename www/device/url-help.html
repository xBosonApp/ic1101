<div id='url_helper_frame'>
  <h2>总线 URL 生成器</h2>
  
  <form class="pure-form pure-form-stacked">
    <fieldset>

      <div class="pure-g">
        <div class="pure-u-1 pure-u-md-1-4">
          <legend>选择总线类型</legend>
          <label>
            <input type="radio" name='bus_type' for='#modbus'/>MODBUS 总线
          </label>

          <label>
            <input type="radio" name='bus_type' for='#allover'/>随机数(测试)
          </label>
        </div>

        <div class="hide pure-u-md-1-4 pure-u-1 " id='modbus'>
          <legend>选择连接器</legend>
          <div class='hostport hide'>
            <label>域名/IP : 端口</label>
            <input type='text' name='host' value='localhost:502'>
          </div>

          <div class='serport hide'>
            <label>串口</label>
            <input type='text' name='host' value='/dev/ttyUSB0'>
          </div>

          <label>
            <input type="radio" name='scheme' value='rtuovertcp://'
              for='#allover, .hostport'/>TCP-RTU 模式
          </label>

          <label>
            <input type="radio" name='scheme' value='tcp://'
              for='#allover, .hostport'/>TCP 模式
          </label>

          <label>
            <input type="radio" name='scheme' value='rtu://'
              for='#allover, .serport'/>RTU 模式
          </label>

          <label>
            <input type="radio" name='scheme' value='dtu://'
              for='#dtu, .hostport, #dtu_parm'/>DTU 模式
          </label>
        </div>

        <div class="hide pure-u-md-1-4 pure-u-1 " id='dtu'>
          <legend>选择DTU种类</legend>
          <label>
            <input type="radio" name='path' value='/kh-mt-m'
              for='#allover'/>KH-MT-M
          </label>
        </div>

        <div class="hide pure-u-md-1-4 pure-u-1 " id='dtu_parm'>
          <legend>设置DTU参数</legend>
          <label>超时 (秒)</label>
          <input name='query.timeout' value='10'/>

          <label>
            <input type="radio" name='query.mode' value='1'
              for='#allover' checked/>TCP 模式
          </label>

          <label>
            <input type="radio" name='query.mode' value='2'
              for='#allover'/>RTU 模式
          </label>

          <label>DTU 后置从机地址</label>
          <span id='fixsid'>
            <input name='query.sid' value='1'/>
          </span>
          <span id='autosid'>
            <input name='query.sid' value='-1' type='hidden'/>
          </span>
          <label>
            <input type="radio" name='sid'
              for='#fixsid' checked/>固定从机地址
          </label>
          <label>
            <input type="radio" name='sid' for='#autosid'/>与DTU从机地址相同
          </label>
        </div>

      </div>
    
      <div class="pure-g hide" id='allover'>
        <legend></legend>
        <!-- <div class="pure-u-1 pure-u-md-1-2">
          <label>生成的URL</label>
          <input class="pure-u-23-24 gen_url" readonly/>
        </div> -->
        <div class="pure-u-1 pure-u-md-1-8">
          <!-- <label>操作</label> -->
          <div class="pure-button-group" role="group">
            <button type="submit" 
              class="pure-button button-primary">确定</button>
          </div>
          <span class='ajax-message error-message'></span>
        </div>
      </div>

    </fieldset>
  </form>

<script>
jQuery(function($) {
  const root = $("#url_helper_frame");
  const afor = root.find("[for]");
  const form = root.find("form");
  const gen_url = root.find(".gen_url");


  // radio 的 [for] 指向一个选择器, 当 radio 被选中, 选择器指向
  // 的 dom 显示出来, radio 组中的其他指向被隐藏, 同时禁用表单.
  // 被禁用的表单不会把值复制到 url 中.
  afor.change(function(_, skip) {
    let thiz = $(this);
    let chk = thiz.prop("checked");
    let fo = thiz.attr("for");
    let tar = root.find(fo);
    let name = thiz.attr("name");
    
    if (chk) {
      setTimeout(function() {
        tar.show();
        tar.find(":input").prop("disabled", false);
      }, 1);
    } else {
      tar.hide();
      tar.find(":input").prop("disabled", true);
    }

    if (!skip) {
      root.find("[name='"+ name +"']").trigger("change", 1);
    }
  });

  form.find(":input:not([name=bus_type])").prop("disabled", true);


  form.submit(function() {
    form.trigger("url", get_url());
    form.trigger("close");
    return false;
  });


  function update_url() {
    gen_url.val(get_url());
  }


  function get_url() {
    let arr = form.serializeArray();
    // 关键 url 参数组件, 表单中必须有 name 对应的表单项.
    let part = {
      scheme : "",
      host   : 'localhost',
      path   : '',
      query  : '',
    };

    arr.forEach(function(p) {
      // 保证 query.XXX 不会出现同名
      if (p.name.startsWith("query.")) {
        let name = p.name.substr(6);
        if (part.query == '') part.query = "?";
        else part.query += '&';
        part.query += (name +'='+ p.value);
      } 
      else if (p.value) {
        part[ p.name ] = p.value;
      }
    });

    let url = [part.scheme, part.host, part.path, part.query];
    return url.join("");
  }
});
</script>
</div>